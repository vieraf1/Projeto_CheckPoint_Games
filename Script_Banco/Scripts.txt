--CREATE DATABASE CHECKPOINT_GAMES;

CREATE TABLE FUNCIONARIO(
ID_FUNCIONARIO INT IDENTITY(1,1) NOT NULL PRIMARY KEY,
LOGIN VARCHAR(100) NOT NULL,
SENHA VARCHAR(100) NOT NULL,
NOME_FUNCIONARIO VARCHAR(150) NOT NULL,
NOME_EMPRESA VARCHAR(100) NOT NULL,
CARGO VARCHAR(100) NULL
);
GO

CREATE TABLE CLIENTE(
ID_CLIENTE INT IDENTITY(1,1) NOT NULL PRIMARY KEY,
ID_FUNCIONARIO INT NOT NULL,
NOME VARCHAR(150) NOT NULL,
SOBRENOME VARCHAR(150) NOT NULL,
IDADE INT NULL,
DATA_NASCIMENTO DATE NOT NULL,
CPF VARCHAR(20) NOT NULL,
RG VARCHAR(20) NOT NULL,
ENDERECO VARCHAR(200) NOT NULL,
COMPLEMENTO VARCHAR(100) NULL,
EMAIL VARCHAR(100) NOT NULL,
TELEFONE VARCHAR(20) NOT NULL
);
GO

ALTER TABLE CLIENTE 
ADD FOREIGN KEY (ID_FUNCIONARIO)
REFERENCES FUNCIONARIO (ID_FUNCIONARIO);

CREATE TABLE GAME(
NUMERO_SERIE VARCHAR(50) NOT NULL PRIMARY KEY,
ID_FUNCIONARIO INT NOT NULL,
NOME_TITULO VARCHAR(100) NOT NULL,
VALOR_ALUGUEL FLOAT NOT NULL,
DATA_LANCAMENTO DATE NOT NULL,
FAIXA_ETARIA INT NOT NULL,
GENERO VARCHAR(100) NOT NULL,
CONSOLE VARCHAR(100) NOT NULL,
ESTUDIO VARCHAR(100) NOT NULL,
IC_ALUGADO BIT NULL
);
GO

ALTER TABLE GAME
ADD FOREIGN KEY (ID_FUNCIONARIO)
REFERENCES FUNCIONARIO (ID_FUNCIONARIO);

CREATE TABLE ALUGUEL(
ID_ALUGUEL INT IDENTITY(1,1) NOT NULL PRIMARY KEY,
ID_FUNCIONARIO INT NOT NULL,
ID_CLIENTE INT NOT NULL,
NUMERO_SERIE VARCHAR(50) NOT NULL,
DATA_RETIRADA DATE NOT NULL,
DATA_DEVOLUCAO DATE NOT NULL,
VALOR_PAGAR FLOAT NOT NULL,
DATA_ENTREGA DATE NULL,
DIAS_ATRASO INT NULL,
VALOR_PAGO FLOAT NULL,
TIPO_PAGAMENTO VARCHAR(100) NOT NULL
);
GO

ALTER TABLE ALUGUEL
ADD FOREIGN KEY (ID_FUNCIONARIO)
REFERENCES FUNCIONARIO (ID_FUNCIONARIO);

ALTER TABLE ALUGUEL
ADD FOREIGN KEY (ID_CLIENTE)
REFERENCES CLIENTE (ID_CLIENTE);

ALTER TABLE ALUGUEL
ADD FOREIGN KEY (NUMERO_SERIE)
REFERENCES GAME (NUMERO_SERIE);


-- Relatório Por Game
DECLARE @DATADE DATE, @DATAATE DATE 

SET @DATADE = NULL
SET @DATAATE= NULL

SELECT G.NOME_TITULO AS JOGO, COUNT(*) AS QUANTIDADE
FROM ALUGUEL A
INNER JOIN GAME G ON(A.NUMERO_SERIE = G.NUMERO_SERIE)
WHERE (@DATADE IS NULL OR @DATAATE IS NULL) OR A.DATA_RETIRADA BETWEEN @DATADE AND @DATAATE
GROUP BY G.NOME_TITULO
ORDER BY COUNT(*) DESC

-- Relatório por Gênero
DECLARE @DATADE DATE, @DATAATE DATE 

SET @DATADE = NULL
SET @DATAATE= NULL

SELECT G.GENERO AS GÊNERO, COUNT(*) AS QUANTIDADE
FROM ALUGUEL A
INNER JOIN GAME G ON(A.NUMERO_SERIE = G.NUMERO_SERIE)
WHERE (@DATADE IS NULL OR @DATAATE IS NULL) OR A.DATA_RETIRADA BETWEEN @DATADE AND @DATAATE
GROUP BY G.GENERO
ORDER BY COUNT(*) DESC